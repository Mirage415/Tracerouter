<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8" />
  <title>è¯­éŸ³æ§åˆ¶Tracerouteå¯è§†åŒ–</title>
  <!-- åŸºç¡€åº“ -->
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/addons/p5.sound.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/IDMNYU/p5.js-speech@0.0.3/lib/p5.speech.js"></script> -->
  <script src="lib/p5/p5.js"></script>
  <script src="lib/p5/p5.speech.js"></script>
  <script src = "lib/p5/addons/p5.sound.min.js"></script>
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/addons/p5.sound.min.js"></script> -->
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #111;
      color: #fff;
      font-family: Arial, sans-serif;
    }

    #ui-panel {
      position: absolute;
      left: 20px;
      top: 20px;
      z-index: 10;
      background: rgba(0, 0, 0, 0.7);
      padding: 15px;
      border-radius: 10px;
      width: 300px;
    }

    #control-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    button {
      background: #05c9fa;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }

    button:disabled {
      background: #666;
      cursor: not-allowed;
    }

    #result {
      margin-top: 10px;
      font-size: 1.2em;
      background: rgba(255, 255, 255, 0.1);
      padding: 10px;
      border-radius: 5px;
      min-height: 1.5em;
    }

    #output-panel {
      position: absolute;
      left: 20px;
      top: 180px;
      z-index: 10;
      background: rgba(0, 0, 0, 0.7);
      padding: 15px;
      border-radius: 10px;
      width: 400px;
      max-height: 60vh;
      overflow-y: auto;
    }

    #traceOutput {
      font-family: monospace;
      white-space: pre-wrap;
      font-size: 0.9em;
      color: #ddd;
    }

    #debugPanel {
      position: absolute;
      right: 20px;
      top: 20px;
      z-index: 10;
      background: rgba(0, 0, 0, 0.7);
      padding: 15px;
      border-radius: 10px;
      width: 300px;
      max-height: 60vh;
      overflow-y: auto;
    }

    #debugOutput {
      font-family: monospace;
      white-space: pre-wrap;
      font-size: 0.9em;
      color: #0f0;
    }

    h3 {
      margin-top: 0;
      color: #05c9fa;
    }

    #rawInput {
      margin-top: 10px;
      width: 90%;
      padding: 8px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 5px;
      color: white;
    }

    #submitBtn {
      margin-top: 5px;
    }
  </style>
</head>

<body>
  <div id="ui-panel">
    <h3>è¯­éŸ³æ§åˆ¶Traceroute</h3>
    <div id="control-buttons">
      <button id="startBtn">ğŸ™ï¸ å¼€å§‹è¯†åˆ«</button>
      <button id="stopBtn" disabled>â¹ï¸ åœæ­¢è¯†åˆ«</button>
      <button id="testBtn">æµ‹è¯•API</button>
    </div>
    <div id="result">ï¼ˆå°šæœªå¼€å§‹ï¼‰</div>
    <p style="font-size:0.8em;color:#ccc;">ç›´æ¥è¯´å‡ºåŸŸåï¼Œä¾‹å¦‚ï¼š"google.com" æˆ– "ç™¾åº¦"</p>

    <!-- æ·»åŠ æ‰‹åŠ¨è¾“å…¥æ¡† -->
    <input type="text" id="rawInput" placeholder="æˆ–ç›´æ¥è¾“å…¥åŸŸå...">
    <button id="submitBtn">æäº¤</button>
  </div>

  <div id="output-panel">
    <h3>æ‰§è¡Œç»“æœï¼š</h3>
    <div id="traceOutput"></div>
  </div>

  <!-- æ–°å¢è°ƒè¯•ä¿¡æ¯é¢æ¿ -->
  <div id="debugPanel">
    <h3>è°ƒè¯•ä¿¡æ¯ï¼š</h3>
    <div id="debugOutput">ç­‰å¾…è°ƒè¯•ä¿¡æ¯...</div>
  </div>

  <script>
    // æ·»åŠ è°ƒè¯•æ—¥å¿—å‡½æ•°
    function debugLog(message) {
      const debugElem = document.getElementById('debugOutput');
      const timestamp = new Date().toLocaleTimeString();
      debugElem.innerHTML += `[${timestamp}] ${message}\n`;
      debugElem.scrollTop = debugElem.scrollHeight;
      console.log(`[DEBUG] ${message}`);
    }

    // è¯­éŸ³è¯†åˆ«éƒ¨åˆ†
    let speechRec;
    let mic;
    let lang = 'zh-CN'; // å¯åˆ‡æ¢ 'en-US' æˆ– 'zh-CN'
    let textResult = "ç­‰å¾…è¯­éŸ³è¾“å…¥...";
    let isRecognizing = false;
    let nativeSpeechRecognition = null;

    // å¤„ç†åŸŸåæ ¼å¼åŒ–
    function formatDomain(text) {
      // ç§»é™¤å¯èƒ½å­˜åœ¨çš„"traceroute"å…³é”®å­—
      let domain = text.toLowerCase().replace(/traceroute\s+/g, '').trim();

      // ç§»é™¤å°¾éƒ¨çš„æ ‡ç‚¹ç¬¦å·ï¼ˆå¦‚å¥å·ã€é€—å·ã€æ„Ÿå¹å·ç­‰ï¼‰
      domain = domain.replace(/[.,!?;:'"ï¼Œã€‚ï¼ï¼Ÿï¼›ï¼š''""ï¼‰ã€‘ã€‹ã€‰ï¼‰]\s*$/g, '').trim();

      // ç§»é™¤å‰åçš„æ ‡ç‚¹ç¬¦å·å’Œç‰¹æ®Šå­—ç¬¦
      domain = domain.replace(/^[\s"'ã€Šã€ï¼ˆ\['"\(]+|[\s"'ã€‹ã€‘ï¼‰\]'"\)]+$/g, '').trim();

      // å¤„ç†å¸¸è§åŸŸåç®€å†™
      const domainMap = {
        'è°·æ­Œ': 'google.com',
        'ç™¾åº¦': 'baidu.com',
        'google': 'google.com',
        'baidu': 'baidu.com',
        'å¿…åº”': 'bing.com',
        'bing': 'bing.com',
        'é›…è™': 'yahoo.com',
        'yahoo': 'yahoo.com',
        'æ·˜å®': 'taobao.com',
        'taobao': 'taobao.com',
        'å¾®è½¯': 'microsoft.com',
        'microsoft': 'microsoft.com',
        'è…¾è®¯': 'qq.com',
        'ç½‘æ˜“': '163.com'
      };

      // æ£€æŸ¥æ˜¯å¦æ˜¯å¸¸è§åŸŸåç®€å†™
      if (domainMap[domain]) {
        domain = domainMap[domain];
      }

      // å¦‚æœæ²¡æœ‰.com, .cnç­‰åç¼€ï¼Œè‡ªåŠ¨æ·»åŠ .com
      if (!/\.\w+$/.test(domain)) {
        domain = domain + '.com';
      }

      // ç¡®ä¿åŸŸåæ ¼å¼æ­£ç¡®ï¼ˆåªåŒ…å«å­—æ¯ã€æ•°å­—ã€ç‚¹å’Œè¿å­—ç¬¦ï¼‰
      if (!/^[a-z0-9.-]+\.[a-z]{2,}$/i.test(domain)) {
        // å°è¯•ä¿®å¤å¸¸è§é—®é¢˜
        domain = domain
          // ç§»é™¤æ‰€æœ‰ç©ºæ ¼
          .replace(/\s+/g, '')
          // å°†å¤šä¸ªç‚¹ç¼©å‡ä¸ºä¸€ä¸ªç‚¹
          .replace(/\.{2,}/g, '.')
          // æ¸…ç†æœ«å°¾çš„ç‚¹
          .replace(/\.$/, '');
      }

      debugLog(`åŸå§‹è¾“å…¥: "${text}" -> å¤„ç†ååŸŸå: "${domain}"`);
      return domain;
    }

    // å°è¯•ä½¿ç”¨åŸç”ŸSpeechRecognition API
    function setupNativeSpeechRecognition() {
      try {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
          debugLog("ä½¿ç”¨åŸç”ŸSpeechRecognition API");
          nativeSpeechRecognition = new SpeechRecognition();
          nativeSpeechRecognition.continuous = true;
          nativeSpeechRecognition.interimResults = false;
          nativeSpeechRecognition.lang = lang;

          nativeSpeechRecognition.onstart = () => {
            debugLog("åŸç”Ÿè¯­éŸ³è¯†åˆ«å·²å¯åŠ¨");
            isRecognizing = true;
            document.getElementById('result').innerText = 'æ­£åœ¨è†å¬(åŸç”ŸAPI)...';
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
          };

          nativeSpeechRecognition.onresult = (event) => {
            debugLog("åŸç”Ÿè¯­éŸ³è¯†åˆ«æ”¶åˆ°ç»“æœ");
            const last = event.results.length - 1;
            const txt = event.results[last][0].transcript.trim();

            const confidence = event.results[last][0].confidence;
            debugLog(`è¯†åˆ«æ–‡æœ¬: "${txt}" (ç½®ä¿¡åº¦: ${confidence.toFixed(2)})`);

            textResult = txt;
            document.getElementById('result').innerText = txt;

            processCommand(txt);
          };

          nativeSpeechRecognition.onerror = (event) => {
            debugLog(`åŸç”Ÿè¯­éŸ³è¯†åˆ«é”™è¯¯: ${event.error}`);
            document.getElementById('result').innerText = `é”™è¯¯: ${event.error}`;
          };

          nativeSpeechRecognition.onend = () => {
            debugLog("åŸç”Ÿè¯­éŸ³è¯†åˆ«ç»“æŸ");
            if (isRecognizing) {
              // å¦‚æœä»åœ¨è¯†åˆ«çŠ¶æ€ä½†APIç»“æŸäº†ï¼Œå°è¯•é‡å¯
              debugLog("å°è¯•é‡å¯åŸç”Ÿè¯­éŸ³è¯†åˆ«...");
              nativeSpeechRecognition.start();
            }
          };

          return true;
        }
      } catch (e) {
        debugLog(`è®¾ç½®åŸç”Ÿè¯­éŸ³è¯†åˆ«å¤±è´¥: ${e.message}`);
      }
      return false;
    }

    // æ£€æŸ¥æ˜¯å¦æœ‰Electron APIå¯ç”¨ï¼ˆåœ¨æ‰“åŒ…åº”ç”¨ä¸­è¿è¡Œï¼‰
    const hasElectronAPI = window.api && window.api.runTraceroute && window.api.onOutput;
    debugLog(`Electron API å¯ç”¨: ${hasElectronAPI}`);
    if (!hasElectronAPI) {
      debugLog("è­¦å‘Š: Electron API ä¸å¯ç”¨ï¼Œéƒ¨åˆ†åŠŸèƒ½å°†æ— æ³•ä½¿ç”¨");
    }

    // å¤„ç†è¯†åˆ«çš„å‘½ä»¤
    function processCommand(txt) {
      // ç»Ÿä¸€ä¸ºåŸŸåæ ¼å¼
      const domain = formatDomain(txt);
      debugLog(`å¤„ç†åçš„åŸŸå: ${domain}`);

      // æ„é€ å®Œæ•´çš„tracerouteå‘½ä»¤
      const command = `traceroute ${domain}`;

      if (hasElectronAPI) {
        debugLog(`æ‰§è¡Œå‘½ä»¤: ${command}`);
        document.getElementById('traceOutput').innerHTML = `æ‰§è¡Œ: ${command}\næ­£åœ¨è¿½è¸ªè·¯ç”±...\n`;
        // é€šè¿‡preload.jsä¸­æš´éœ²çš„APIè°ƒç”¨ä¸»è¿›ç¨‹
        window.api.runTraceroute(command);
      } else {
        debugLog(`æ— æ³•æ‰§è¡Œå‘½ä»¤: Electron APIä¸å¯ç”¨`);
        document.getElementById('traceOutput').innerHTML = "é”™è¯¯: Electron APIä¸å¯ç”¨ï¼Œæ— æ³•æ‰§è¡Œå‘½ä»¤\n";
      }
    }

    document.getElementById('startBtn').onclick = async () => {
      try {
        debugLog("å°è¯•å¼€å§‹è¯­éŸ³è¯†åˆ«...");

        // å°è¯•ä½¿ç”¨åŸç”Ÿè¯­éŸ³è¯†åˆ«
        if (setupNativeSpeechRecognition()) {
          nativeSpeechRecognition.start();
          return;
        }

        // å›é€€åˆ°p5.speech
        debugLog("å›é€€åˆ°p5.speechè¯­éŸ³è¯†åˆ«");
        await getAudioContext().resume();
        debugLog("éŸ³é¢‘ä¸Šä¸‹æ–‡å·²æ¢å¤");

        mic = new p5.AudioIn();
        await mic.start();
        debugLog("éº¦å…‹é£å·²å¯åŠ¨");

        // åˆ›å»ºæ–°çš„è¯­éŸ³è¯†åˆ«å®ä¾‹
        speechRec = new p5.SpeechRec(lang, gotSpeech);
        debugLog(`åˆ›å»ºè¯­éŸ³è¯†åˆ«å®ä¾‹ï¼Œè¯­è¨€: ${lang}`);

        // å¼€å§‹è¿ç»­è¯†åˆ« (continuous = true, interim = false)
        speechRec.start(true, false);
        debugLog("è¯­éŸ³è¯†åˆ«å·²å¯åŠ¨ï¼Œè¿ç»­æ¨¡å¼");

        isRecognizing = true;
        document.getElementById('result').innerText = 'æ­£åœ¨è†å¬(p5.speech)...';
        document.getElementById('startBtn').disabled = true;
        document.getElementById('stopBtn').disabled = false;
      } catch (error) {
        debugLog(`é”™è¯¯: ${error.message}`);
        console.error("è¯­éŸ³è¯†åˆ«é”™è¯¯:", error);
        document.getElementById('result').innerText = `å¯åŠ¨å¤±è´¥: ${error.message}`;
      }
    };

    document.getElementById('stopBtn').onclick = () => {
      debugLog("åœæ­¢è¯­éŸ³è¯†åˆ«");

      if (nativeSpeechRecognition && isRecognizing) {
        try {
          nativeSpeechRecognition.stop();
          debugLog("åŸç”Ÿè¯­éŸ³è¯†åˆ«å·²åœæ­¢");
        } catch (e) {
          debugLog(`åœæ­¢åŸç”Ÿè¯­éŸ³è¯†åˆ«å‡ºé”™: ${e.message}`);
        }
      }

      if (speechRec) {
        // å°è¯•åœæ­¢è¯­éŸ³è¯†åˆ«
        try {
          speechRec.stop();
          debugLog("p5è¯­éŸ³è¯†åˆ«å·²åœæ­¢");
        } catch (e) {
          debugLog(`åœæ­¢p5è¯­éŸ³è¯†åˆ«å‡ºé”™: ${e.message}`);
          console.log("åœæ­¢è¯­éŸ³è¯†åˆ«æ—¶å‡ºé”™:", e);
        }
      }

      isRecognizing = false;
      document.getElementById('result').innerText = 'ï¼ˆå·²åœæ­¢ï¼‰';
      document.getElementById('startBtn').disabled = false;
      document.getElementById('stopBtn').disabled = true;
      textResult = "è¯­éŸ³è¯†åˆ«å·²åœæ­¢";
    };

    // æµ‹è¯•APIæŒ‰é’®
    document.getElementById('testBtn').onclick = () => {
      debugLog("æµ‹è¯•æŒ‰é’®ç‚¹å‡»");
      const testDomain = "google.com";
      document.getElementById('result').innerText = testDomain;
      processCommand(testDomain);
    };

    // æ‰‹åŠ¨è¾“å…¥æäº¤æŒ‰é’®
    document.getElementById('submitBtn').onclick = () => {
      const inputField = document.getElementById('rawInput');
      const domain = inputField.value.trim();
      if (domain) {
        debugLog(`æ‰‹åŠ¨è¾“å…¥åŸŸå: ${domain}`);
        document.getElementById('result').innerText = domain;
        processCommand(domain);
        // æ¸…ç©ºè¾“å…¥æ¡†
        inputField.value = '';
      } else {
        debugLog("æœªè¾“å…¥åŸŸå");
      }
    };

    // å…è®¸å›è½¦é”®æäº¤
    document.getElementById('rawInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('submitBtn').click();
      }
    });

    function gotSpeech() {
      debugLog("æ¥æ”¶åˆ°p5è¯­éŸ³è¯†åˆ«ç»“æœ");
      if (speechRec.resultValue && isRecognizing) {
        const txt = speechRec.resultString.trim();
        debugLog(`p5è¯†åˆ«æ–‡æœ¬: "${txt}"`);
        textResult = txt;
        document.getElementById('result').innerText = txt;

        processCommand(txt);
      } else {
        debugLog(`p5æ— æ•ˆç»“æœæˆ–è¯†åˆ«å·²åœæ­¢: resultValue=${speechRec.resultValue}, isRecognizing=${isRecognizing}`);
      }
    }

    // å¦‚æœåœ¨Electronç¯å¢ƒä¸­ï¼Œè®¾ç½®æ¥æ”¶è¾“å‡ºçš„å›è°ƒ
    if (hasElectronAPI) {
      debugLog("è®¾ç½®Electron APIè¾“å‡ºå›è°ƒ");
      window.api.onOutput((data) => {
        debugLog(`æ¥æ”¶åˆ°è¾“å‡º: ${data.substring(0, 50)}...`);
        const outputElem = document.getElementById('traceOutput');
        outputElem.innerHTML += data;
        outputElem.scrollTop = outputElem.scrollHeight; // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
      });
    } else {
      document.getElementById('traceOutput').innerHTML = "æœªæ£€æµ‹åˆ°Electron APIï¼Œæ— æ³•æ‰§è¡Œtracerouteå‘½ä»¤ã€‚";
    }

    // æ£€æŸ¥æµè§ˆå™¨è¯­éŸ³è¯†åˆ«æ”¯æŒ
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      debugLog("æµè§ˆå™¨æ”¯æŒåŸç”Ÿè¯­éŸ³è¯†åˆ«API");
    } else {
      debugLog("è­¦å‘Š: æµè§ˆå™¨ä¸æ”¯æŒåŸç”Ÿè¯­éŸ³è¯†åˆ«APIï¼Œå°†å°è¯•ä½¿ç”¨p5.speech");
    }

    // æ³¢å½¢åŠ¨ç”»éƒ¨åˆ†
    let curves = 150;
    let cx, cy;
    let angles = [], baseRs = [], phases1 = [], phases2 = [], speeds1 = [], speeds2 = [];

    function setup() {
      createCanvas(windowWidth, windowHeight);
      cx = width / 2;
      cy = height / 2;
      for (let i = 0; i < curves; i++) {
        angles.push(map(i, 0, curves, 0, TWO_PI));
        baseRs.push(random(height * 0.15, height * 0.3));
        phases1.push(random(TWO_PI));
        phases2.push(random(TWO_PI));
        speeds1.push(random(0.02, 0.08));
        speeds2.push(random(0.02, 0.08));
      }
      stroke(255);
      debugLog("p5.jsç”»å¸ƒåˆå§‹åŒ–å®Œæˆ");
    }

    function draw() {
      background(20);
      let vol = mic ? mic.getLevel() : 0;
      // å¶å°”è®°å½•éŸ³é‡çº§åˆ«
      if (frameCount % 60 === 0 && mic) {
        debugLog(`å½“å‰éº¦å…‹é£éŸ³é‡: ${vol.toFixed(4)}`);
      }

      let maxAmp = map(vol, 0, 0.3, 0, height * 0.15);
      for (let i = 0; i < curves; i++) {
        phases1[i] += speeds1[i];
        phases2[i] += speeds2[i];
        let r = baseRs[i];
        let off1 = 50 * sin(phases1[i]) * maxAmp + 5 * sin(random(5, 15));
        let off2 = 50 * sin(phases2[i]) * maxAmp + 5 * sin(random(5, 15));
        let cp1x = cx + cos(angles[i]) * (r + off1);
        let cp1y = cy + sin(angles[i]) * (r + off1);
        let cp2x = cx + cos(angles[i]) * (r + off2);
        let cp2y = cy + sin(angles[i]) * (r + off2);
        stroke('#05c9fa');
        bezier(cx, cy, cp1x, cp1y, cp2x, cp2y, cx, cy);
      }
    }

    function windowResized() {
      resizeCanvas(windowWidth, windowHeight);
      cx = width / 2;
      cy = height / 2;
      debugLog("çª—å£å¤§å°è°ƒæ•´ï¼Œç”»å¸ƒå·²é‡ç½®");
    }

    // é¡µé¢åŠ è½½å®Œæˆ
    window.onload = function () {
      debugLog("é¡µé¢åŠ è½½å®Œæˆ");
    };
  </script>
</body>

</html>